<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Demand & Supply Drag Playground</title>
<style>
  :root {
    --bg:#070b18;
    --card:#111827;
    --accent1:#ff5fa2;
    --accent2:#4ade80;
    --accent3:#38bdf8;
    --accent4:#facc15;
    --accentShort:#f97373;
    --accentSurp:#4ade80;
    --text-main:#e5e7eb;
    --text-soft:#9ca3af;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;padding:16px;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:radial-gradient(circle at top,#1e293b 0,var(--bg) 55%);
    color:var(--text-main);
    display:flex;justify-content:center;
    font-size:18px;
  }
  .app{max-width:1400px;width:100%;}
  h1{text-align:center;margin:0 0 12px;font-size:36px;font-weight:700;}
  .hint{text-align:center;font-size:18px;color:var(--text-soft);margin-bottom:16px;line-height:1.6;}
  .top-row{display:flex;flex-wrap:wrap;gap:16px;}

  #graph-wrapper{
    flex:2.2 1 640px;
    background:linear-gradient(135deg,#020617 0,#020617 40%,#111827 100%);
    border-radius:18px;
    padding:14px;
    box-shadow:0 18px 40px rgba(0,0,0,0.55);
  }
  #graph{
    display:block;
    width:100%;
    border-radius:14px;
    background:radial-gradient(circle at top left,#1f2937 0,#020617 55%);
    touch-action:none;
  }
  .emoji-row{
    margin-top:10px;
    text-align:center;
  }
  .emoji-box{
    display:inline-block;
    padding:10px 20px;
    border-radius:22px;
    background:rgba(15,23,42,0.96);
    border:1px solid rgba(148,163,184,0.7);
    box-shadow:0 10px 26px rgba(0,0,0,0.55);
  }
  .emoji-face{
    font-size:70px;
    line-height:1.1;
  }
  .emoji-text{
    font-size:20px;
    color:var(--text-soft);
    margin-top:8px;
    max-width:600px;
    line-height:1.5;
  }
  .pop{animation:pop 0.45s ease-out;}
  @keyframes pop{
    0%{transform:scale(.8);opacity:.6;}
    40%{transform:scale(1.12);opacity:1;}
    100%{transform:scale(1);}
  }
  .badge-row{
    display:flex;justify-content:space-between;
    font-size:18px;margin-top:12px;color:var(--text-soft);
  }
  .badge{
    padding:8px 18px;border-radius:999px;
    background:rgba(15,23,42,0.9);
    border:1px solid rgba(148,163,184,0.3);
    font-weight:500;
  }

  .controls-card{
    flex:1 1 260px;
    background:var(--card);
    border-radius:18px;
    padding:12px 14px;
    box-shadow:0 14px 30px rgba(0,0,0,0.6);
    border:1px solid rgba(148,163,184,0.35);
  }
  h2{margin:0 0 8px;font-size:20px;color:var(--text-soft);font-weight:600;}

  .market-row{
    margin-bottom:12px;
    font-size:16px;
  }
  .market-row label{
    display:block;
    margin-bottom:4px;
    font-weight:500;
  }
  #marketSelect{
    width:100%;
    padding:12px 14px;
    border-radius:8px;
    border:1px solid rgba(148,163,184,0.6);
    background:#020617;
    color:var(--text-main);
    font-size:18px;
    min-height:60px;
    cursor:pointer;
  }
  .market-desc{
    font-size:16px;
    color:var(--text-soft);
    margin-top:8px;
    line-height:1.5;
  }

  .group-label{font-size:18px;font-weight:600;margin:12px 0 6px;}
  .control-row{display:flex;flex-direction:column;margin-bottom:10px;font-size:16px;}
  .control-row span{display:flex;justify-content:space-between;gap:8px;}
  input[type="range"]{
    width:100%;
    accent-color:var(--accent3);
    height:40px;
    cursor:pointer;
  }
  input[type="range"]::-webkit-slider-thumb{
    width:40px;
    height:40px;
    cursor:grab;
  }
  input[type="range"]:active::-webkit-slider-thumb{
    cursor:grabbing;
  }
  input[type="range"]::-moz-range-thumb{
    width:40px;
    height:40px;
    cursor:grab;
  }
  input[type="range"]:active::-moz-range-thumb{
    cursor:grabbing;
  }
  .mini{color:var(--text-soft);font-size:15px;line-height:1.5;}
  .stats{margin-top:12px;font-size:17px;line-height:1.6;}
  .stats-line{margin-top:6px;}
  .legend{margin-top:12px;font-size:15px;color:var(--text-soft);line-height:1.8;}
  .legend span{display:inline-flex;align-items:center;margin-right:12px;}
  .dot{width:14px;height:14px;border-radius:999px;display:inline-block;margin-right:6px;}
  .dot-demand{background:var(--accent1);}
  .dot-supply{background:var(--accent2);}
  .dot-eq{background:var(--accent4);}
  .dot-price{background:var(--accent3);}
  .dot-short{background:var(--accentShort);}
  .dot-surp{background:var(--accentSurp);}

  .button-row{
    display:flex;
    gap:10px;
    margin:16px 0;
    flex-wrap:wrap;
  }
  .scenario-btn, .reset-btn{
    flex:1;
    min-width:120px;
    padding:16px 20px;
    font-size:16px;
    font-weight:600;
    border-radius:12px;
    border:2px solid rgba(148,163,184,0.5);
    cursor:pointer;
    transition:all 0.2s ease;
    min-height:60px;
  }
  .scenario-btn{
    background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    color:var(--text-main);
  }
  .scenario-btn:hover{
    background:linear-gradient(135deg, #334155 0%, #1e293b 100%);
    border-color:var(--accent3);
    transform:translateY(-2px);
    box-shadow:0 6px 16px rgba(0,0,0,0.4);
  }
  .scenario-btn:active{
    transform:translateY(0);
  }
  .reset-btn{
    background:linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    color:#fff;
    border-color:#dc2626;
  }
  .reset-btn:hover{
    background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    transform:translateY(-2px);
    box-shadow:0 6px 16px rgba(220,38,38,0.4);
  }
  .reset-btn:active{
    transform:translateY(0);
  }

  #coordDisplay{
    position:absolute;
    top:10px;
    right:10px;
    background:rgba(15,23,42,0.95);
    padding:12px 16px;
    border-radius:10px;
    border:2px solid var(--accent3);
    font-size:16px;
    font-family:monospace;
    color:var(--accent3);
    font-weight:600;
    pointer-events:none;
    box-shadow:0 4px 12px rgba(0,0,0,0.6);
    display:none;
  }

  .dragging-cursor{cursor:grabbing !important;}

  .glow-eq{
    animation:glowPulse 2s ease-in-out infinite;
  }
  @keyframes glowPulse{
    0%, 100%{
      filter:drop-shadow(0 0 8px rgba(250,204,21,0.8));
    }
    50%{
      filter:drop-shadow(0 0 16px rgba(250,204,21,1));
    }
  }

  @media(max-width:820px){
    #graph-wrapper{order:1;}
    .controls-card{order:2;}
  }
</style>
</head>
<body>
<div class="app">
  <h1>ğŸ“ˆ Demand & Supply Drag Playground / éœ€æ±‚ä¸ä¾›ç»™äº’åŠ¨å›¾</h1>
  <div class="hint">
    <strong>Step 1:</strong> Drag near ğŸ’™ demand or ğŸ’š supply curves to shift them. <br>
    <strong>Step 2:</strong> Drag the blue price line P* up or down.<br>
    <strong>Step 3:</strong> Watch how Qáµˆ and QË¢ move along their curves. Try to reach equilibrium!<br>
    <strong>æ­¥éª¤1:</strong> æ‹–åŠ¨ğŸ’™éœ€æ±‚æˆ–ğŸ’šä¾›ç»™æ›²çº¿æ¥ç§»åŠ¨å®ƒä»¬ã€‚<strong>æ­¥éª¤2:</strong> ä¸Šä¸‹æ‹–åŠ¨è“è‰²ä»·æ ¼çº¿P*ã€‚<strong>æ­¥éª¤3:</strong> è§‚å¯ŸQáµˆå’ŒQË¢å¦‚ä½•æ²¿æ›²çº¿ç§»åŠ¨ã€‚è¯•ç€è¾¾åˆ°å‡è¡¡ç‚¹ï¼
  </div>

  <div class="top-row">
    <div id="graph-wrapper">
      <canvas id="graph"></canvas>
      <div id="coordDisplay"></div>

      <div class="emoji-row">
        <div class="emoji-box" id="emojiBox">
          <div class="emoji-face">ğŸ˜</div>
          <div class="emoji-text">
            Move a curve or the price line. I will explain if you are at equilibrium, in shortage, or in surplus.
          </div>
        </div>
      </div>

      <div class="badge-row">
        <div class="badge">Y-axis: Price per unit ğŸ’° / ä»·æ ¼</div>
        <div class="badge">X-axis: Quantity of goods ğŸ“¦ / æ•°é‡</div>
      </div>
    </div>

    <div class="controls-card">
      <h2>ğŸ›ï¸ Control the market / æ§åˆ¶å¸‚åœº</h2>

      <div class="button-row">
        <button class="scenario-btn" onclick="showEquilibrium()">âš–ï¸ Show Equilibrium<br>æ˜¾ç¤ºå‡è¡¡</button>
        <button class="scenario-btn" onclick="showShortage()">ğŸ“‰ Show Shortage<br>æ˜¾ç¤ºçŸ­ç¼º</button>
        <button class="scenario-btn" onclick="showSurplus()">ğŸ“ˆ Show Surplus<br>æ˜¾ç¤ºè¿‡å‰©</button>
        <button class="reset-btn" onclick="resetToDefault()">ğŸ”„ Reset<br>é‡ç½®</button>
      </div>

      <div class="market-row">
        <label for="marketSelect">ğŸ›’ Market example / å¸‚åœºç¤ºä¾‹</label>
        <select id="marketSelect">
          <optgroup label="Elastic Products / éœ€æ±‚å¼¹æ€§å¤§çš„äº§å“ (steep slope / é™¡æ–œç‡)">
            <option value="luxurycar">Luxury Car è±ªåè½¦ (Very Elastic)</option>
            <option value="bubbletea">Bubble Tea å¥¶èŒ¶ (Elastic)</option>
            <option value="smartphone">Smartphone æ™ºèƒ½æ‰‹æœº (Elastic)</option>
            <option value="snacks">Snacks é›¶é£Ÿ (Elastic)</option>
            <option value="movieticket">Movie Ticket ç”µå½±ç¥¨ (Elastic)</option>
          </optgroup>
          <optgroup label="Moderate Elasticity / å¼¹æ€§é€‚ä¸­">
            <option value="schoolsupplies">School Supplies å­¦ä¹ ç”¨å“</option>
          </optgroup>
          <optgroup label="Inelastic Products / éœ€æ±‚æ— å¼¹æ€§çš„äº§å“ (flat slope / å¹³ç¼“æ–œç‡)">
            <option value="rice">Rice å¤§ç±³ (Inelastic)</option>
            <option value="medicine">Medicine è¯å“ (Inelastic)</option>
            <option value="electricity">Electricity ç”µåŠ› (Inelastic)</option>
          </optgroup>
        </select>
        <div class="market-desc" id="marketDesc">
          Popular drink with many alternatives. ELASTIC demand (steep slope) - people easily switch to other drinks if price rises.<br>
          æµè¡Œé¥®æ–™ï¼Œæœ‰å¾ˆå¤šæ›¿ä»£å“ã€‚éœ€æ±‚å¼¹æ€§å¤§ - ä»·æ ¼ä¸Šæ¶¨æ—¶äººä»¬å®¹æ˜“æ”¹å–å…¶ä»–é¥®æ–™ã€‚
        </div>
      </div>

      <div class="elasticity-explainer" style="background:rgba(56,189,248,0.1);padding:12px;border-radius:12px;margin-bottom:12px;border:2px solid rgba(56,189,248,0.3);">
        <div style="font-size:16px;font-weight:600;margin-bottom:6px;">ğŸ“š What is Slope? (Elasticity / å¼¹æ€§)</div>
        <div style="font-size:15px;line-height:1.6;">
          <strong>Slope = How Responsive / æ–œç‡ = ååº”ç¨‹åº¦</strong><br>
          <strong style="color:#4ade80;">â€¢ Steep slope (é™¡) = ELASTIC</strong> - Big Q change when P changes. Easy to switch products.<br>
          <strong style="color:#facc15;">â€¢ Flat slope (å¹³) = INELASTIC</strong> - Small Q change when P changes. Must buy regardless of price.<br>
          <span style="font-size:14px;color:var(--text-soft);">Examples: Luxury items are elastic (steep). Necessities like medicine are inelastic (flat).</span>
        </div>
      </div>

      <div class="group-label">ğŸ’™ Demand curve / éœ€æ±‚æ›²çº¿ P = a<sub>D</sub> âˆ’ b<sub>D</sub>Q</div>
      <div class="control-row">
        <span><span>Intercept a<sub>D</sub> (highest price buyers will pay / ä¹°å®¶æ„¿ä»˜æœ€é«˜ä»·)</span><span id="aDVal"></span></span>
        <input id="aD" type="range" min="30" max="100" step="1" value="80">
      </div>
      <div class="control-row">
        <span><span>Slope b<sub>D</sub> (steepness = how much Q changes / æ–œç‡ = Qå˜åŒ–å¤šå°‘)</span><span id="bDVal"></span></span>
        <input id="bD" type="range" min="15" max="90" step="5" value="40">
      </div>

      <div class="group-label">ğŸ’š Supply curve / ä¾›ç»™æ›²çº¿ P = a<sub>S</sub> + b<sub>S</sub>Q</div>
      <div class="control-row">
        <span><span>Intercept a<sub>S</sub> (lowest price sellers accept / å–å®¶æ¥å—æœ€ä½ä»·)</span><span id="aSVal"></span></span>
        <input id="aS" type="range" min="0" max="60" step="1" value="20">
      </div>
      <div class="control-row">
        <span><span>Slope b<sub>S</sub> (steepness = how fast cost rises / æ–œç‡ = æˆæœ¬ä¸Šå‡é€Ÿåº¦)</span><span id="bSVal"></span></span>
        <input id="bS" type="range" min="10" max="80" step="5" value="30">
      </div>

      <div class="group-label">ğŸ“ Price level / ä»·æ ¼æ°´å¹³</div>
      <div class="control-row">
        <span><span>Price line P* / ä»·æ ¼çº¿</span><span id="pVal"></span></span>
        <input id="priceLine" type="range" min="5" max="95" step="0.1" value="50">
      </div>
      <div class="mini">
        ğŸ’¡ <strong>Tip:</strong> Move P* with this slider or drag the blue line on the graph.<br>
        At that P*, the blue dot is Qáµˆ on demand and green dot is QË¢ on supply.<br>
        æç¤ºï¼šç”¨æ»‘å—æˆ–æ‹–åŠ¨å›¾ä¸Šçš„è“çº¿æ¥ç§»åŠ¨P*ã€‚åœ¨P*å¤„ï¼Œè“ç‚¹æ˜¯éœ€æ±‚é‡Qáµˆï¼Œç»¿ç‚¹æ˜¯ä¾›ç»™é‡QË¢ã€‚
      </div>

      <div class="stats" id="statsBox"></div>

      <div class="legend">
        <span><span class="dot dot-demand"></span>Demand (D) / éœ€æ±‚</span>
        <span><span class="dot dot-supply"></span>Supply (S) / ä¾›ç»™</span>
        <span><span class="dot dot-eq"></span>Equilibrium E / å‡è¡¡ç‚¹</span><br>
        <span><span class="dot dot-price"></span>Price line P* / ä»·æ ¼çº¿</span>
        <span><span class="dot dot-short"></span>Shortage / çŸ­ç¼º</span>
        <span><span class="dot dot-surp"></span>Surplus / è¿‡å‰©</span>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const canvas = document.getElementById("graph");
  const ctx = canvas.getContext("2d");
  const coordDisplay = document.getElementById("coordDisplay");
  const PAD_LEFT = 80, PAD_RIGHT = 50, PAD_TOP = 50, PAD_BOTTOM = 80;
  const maxQ = 100, maxP = 100;

  const aD = document.getElementById("aD");
  const bD = document.getElementById("bD");
  const aS = document.getElementById("aS");
  const bS = document.getElementById("bS");
  const priceLine = document.getElementById("priceLine");

  const aDVal = document.getElementById("aDVal");
  const bDVal = document.getElementById("bDVal");
  const aSVal = document.getElementById("aSVal");
  const bSVal = document.getElementById("bSVal");
  const pVal  = document.getElementById("pVal");
  const statsBox = document.getElementById("statsBox");
  const emojiBox = document.getElementById("emojiBox");

  const marketSelect = document.getElementById("marketSelect");
  const marketDescEl = document.getElementById("marketDesc");

  const markets = {
    bubbletea: {
      label: "Bubble Tea å¥¶èŒ¶",
      aD: 95,
      bD: 55,
      aS: 15,
      bS: 30,
      price: 42,
      desc: "Popular drink with many alternatives. ELASTIC demand (steep slope) - people easily switch to other drinks if price rises. æµè¡Œé¥®æ–™ï¼Œæœ‰å¾ˆå¤šæ›¿ä»£å“ã€‚éœ€æ±‚å¼¹æ€§å¤§ - ä»·æ ¼ä¸Šæ¶¨æ—¶äººä»¬å®¹æ˜“æ”¹å–å…¶ä»–é¥®æ–™ã€‚",
      elasticity: "elastic"
    },
    smartphone: {
      label: "Smartphone æ™ºèƒ½æ‰‹æœº",
      aD: 120,
      bD: 75,
      aS: 35,
      bS: 30,
      price: 58,
      desc: "High-tech necessity. ELASTIC demand (steep slope) - people delay purchase if too expensive. é«˜ç§‘æŠ€å¿…éœ€å“ã€‚éœ€æ±‚å¼¹æ€§å¤§ - å¤ªè´µæ—¶äººä»¬ä¼šæ¨è¿Ÿè´­ä¹°ã€‚",
      elasticity: "elastic"
    },
    movieticket: {
      label: "Movie Ticket ç”µå½±ç¥¨",
      aD: 85,
      bD: 45,
      aS: 10,
      bS: 35,
      price: 38,
      desc: "Entertainment choice. ELASTIC demand (steeper slope) - many entertainment alternatives. å¨±ä¹é€‰æ‹©ã€‚éœ€æ±‚å¼¹æ€§å¤§ - æœ‰å¾ˆå¤šå¨±ä¹æ›¿ä»£å“ã€‚",
      elasticity: "elastic"
    },
    schoolsupplies: {
      label: "School Supplies å­¦ä¹ ç”¨å“",
      aD: 75,
      bD: 40,
      aS: 8,
      bS: 25,
      price: 28,
      desc: "Student necessity. MODERATE elasticity - students need them but may buy less if expensive. å­¦ç”Ÿå¿…éœ€å“ã€‚å¼¹æ€§é€‚ä¸­ - å­¦ç”Ÿéœ€è¦ä½†å¤ªè´µä¼šå°‘ä¹°ã€‚",
      elasticity: "moderate"
    },
    medicine: {
      label: "Medicine è¯å“",
      aD: 110,
      bD: 20,
      aS: 25,
      bS: 40,
      price: 58,
      desc: "Health necessity. INELASTIC demand (flat slope) - people buy regardless of price when sick. å¥åº·å¿…éœ€å“ã€‚éœ€æ±‚æ— å¼¹æ€§ï¼ˆå¹³ç¼“æ–œç‡ï¼‰- ç”Ÿç—…æ—¶æ— è®ºä»·æ ¼éƒ½ä¼šä¹°ã€‚",
      elasticity: "inelastic"
    },
    electricity: {
      label: "Electricity ç”µåŠ›",
      aD: 105,
      bD: 18,
      aS: 20,
      bS: 50,
      price: 65,
      desc: "Daily necessity. INELASTIC demand (very flat slope) - people need it and cannot easily reduce use. æ—¥å¸¸å¿…éœ€ã€‚éœ€æ±‚æ— å¼¹æ€§ï¼ˆå¾ˆå¹³ç¼“ï¼‰- äººä»¬éœ€è¦ä¸”éš¾ä»¥å‡å°‘ä½¿ç”¨ã€‚",
      elasticity: "inelastic"
    },
    rice: {
      label: "Rice å¤§ç±³",
      aD: 95,
      bD: 15,
      aS: 12,
      bS: 35,
      price: 48,
      desc: "Staple food. INELASTIC demand (flat slope) - main food source, people must buy it. ä¸»é£Ÿã€‚éœ€æ±‚æ— å¼¹æ€§ï¼ˆå¹³ç¼“æ–œç‡ï¼‰- ä¸»è¦é£Ÿç‰©æ¥æºï¼Œäººä»¬å¿…é¡»è´­ä¹°ã€‚",
      elasticity: "inelastic"
    },
    luxurycar: {
      label: "Luxury Car è±ªåè½¦",
      aD: 130,
      bD: 85,
      aS: 45,
      bS: 35,
      price: 65,
      desc: "Luxury item. HIGHLY ELASTIC demand (very steep) - only buy when price is right. å¥¢ä¾ˆå“ã€‚é«˜åº¦å¼¹æ€§éœ€æ±‚ï¼ˆå¾ˆé™¡ï¼‰- åªåœ¨ä»·æ ¼åˆé€‚æ—¶è´­ä¹°ã€‚",
      elasticity: "very-elastic"
    },
    snacks: {
      label: "Snacks é›¶é£Ÿ",
      aD: 80,
      bD: 50,
      aS: 8,
      bS: 22,
      price: 32,
      desc: "Optional treats. ELASTIC demand (steep slope) - easy to skip if expensive. å¯é€‰é›¶é£Ÿã€‚éœ€æ±‚å¼¹æ€§å¤§ï¼ˆé™¡æ–œç‡ï¼‰- å¤ªè´µå°±ä¸ä¹°ã€‚",
      elasticity: "elastic"
    }
  };

  let currAD=80, currBD=1, currAS=20, currBS=1;
  let dragTarget=null;
  let dragStart=null;
  let currentMarketLabel = "Custom market / è‡ªå®šä¹‰å¸‚åœº";
  let showGrid = true;

  function resizeCanvas(){
    const wrapper = document.getElementById("graph-wrapper");
    const w = wrapper.clientWidth - 28;
    const h = Math.max(380, w * 0.75);
    canvas.width = w;
    canvas.height = h;
    updateValues();
  }

  function qToX(q){
    const w = canvas.width - PAD_LEFT - PAD_RIGHT;
    return PAD_LEFT + (q / maxQ) * w;
  }
  function pToY(p){
    const h = canvas.height - PAD_TOP - PAD_BOTTOM;
    return PAD_TOP + (1 - p / maxP) * h;
  }
  function yToP(y){
    const h = canvas.height - PAD_TOP - PAD_BOTTOM;
    const rel = (y - PAD_TOP) / h;
    return (1 - rel) * maxP;
  }

  function drawAxes(){
    ctx.strokeStyle = "#64748b";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(PAD_LEFT, PAD_TOP);
    ctx.lineTo(PAD_LEFT, canvas.height - PAD_BOTTOM);
    ctx.lineTo(canvas.width - PAD_RIGHT, canvas.height - PAD_BOTTOM);
    ctx.stroke();

    // Draw gridlines
    if(showGrid){
      ctx.strokeStyle = "rgba(100,116,139,0.15)";
      ctx.lineWidth = 1;
      for(let p=10;p<=100;p+=10){
        const y = pToY(p);
        ctx.beginPath();
        ctx.moveTo(PAD_LEFT, y);
        ctx.lineTo(canvas.width - PAD_RIGHT, y);
        ctx.stroke();
      }
      for(let q=10;q<=100;q+=10){
        const x = qToX(q);
        ctx.beginPath();
        ctx.moveTo(x, PAD_TOP);
        ctx.lineTo(x, canvas.height - PAD_BOTTOM);
        ctx.stroke();
      }
    }

    ctx.fillStyle = "#e5e7eb";
    ctx.font = "bold 22px system-ui";
    ctx.fillText("Price ğŸ’° / ä»·æ ¼", 10, PAD_TOP - 18);
    ctx.fillText("Quantity ğŸ“¦ / æ•°é‡", canvas.width - PAD_RIGHT - 200, canvas.height - 14);

    ctx.fillStyle = "#9ca3af";
    ctx.font = "16px system-ui";
    ctx.strokeStyle = "#64748b";
    ctx.lineWidth = 2;
    for(let p=20;p<=100;p+=20){
      const y = pToY(p);
      ctx.beginPath();
      ctx.moveTo(PAD_LEFT-8, y);
      ctx.lineTo(PAD_LEFT+8, y);
      ctx.stroke();
      ctx.fillText(p.toString(), 28, y+6);
    }
    for(let q=20;q<=100;q+=20){
      const x = qToX(q);
      ctx.beginPath();
      ctx.moveTo(x, canvas.height - PAD_BOTTOM - 8);
      ctx.lineTo(x, canvas.height - PAD_BOTTOM + 8);
      ctx.stroke();
      ctx.fillText(q.toString(), x-12, canvas.height - 44);
    }
  }

  function drawCurve(color, fnP){
    ctx.strokeStyle = color;
    ctx.lineWidth = 4;
    ctx.beginPath();
    let started=false;
    for(let q=0;q<=maxQ;q+=0.5){
      const p = fnP(q);
      if(p<0||p>maxP) continue;
      const x=qToX(q), y=pToY(p);
      if(!started){ctx.moveTo(x,y);started=true;}
      else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  function drawDot(x,y,color,r=8){
    ctx.fillStyle=color;
    ctx.beginPath();
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fill();
    ctx.strokeStyle="rgba(15,23,42,0.9)";
    ctx.lineWidth=2;
    ctx.stroke();
  }

  function drawDotWithLabel(x,y,color,label,value,r=8){
    drawDot(x,y,color,r);
    ctx.fillStyle=color;
    ctx.font="bold 16px system-ui";
    ctx.strokeStyle="rgba(15,23,42,0.95)";
    ctx.lineWidth=3;
    ctx.strokeText(`${label} = ${value}`, x+14, y-10);
    ctx.fillText(`${label} = ${value}`, x+14, y-10);
  }

  function labelCurve(letter, color, qPos){
    const Pd = q => currAD - currBD*q;
    const Ps = q => currAS + currBS*q;
    let pVal;
    if(letter === "D") pVal = Pd(qPos);
    else pVal = Ps(qPos);
    if(pVal<0||pVal>maxP) return;
    const x = qToX(qPos);
    const y = pToY(pVal);
    ctx.font = "bold 28px system-ui";
    ctx.lineWidth = 5;
    ctx.strokeStyle = "rgba(15,23,42,0.95)";
    ctx.strokeText(letter, x+14, y-12);
    ctx.fillStyle = color;
    ctx.fillText(letter, x+14, y-12);
  }

  function setEmoji(mode){
    let emoji="ğŸ˜¶", text="Move the price line or a curve. I will explain what the market is doing. / ç§»åŠ¨ä»·æ ¼çº¿æˆ–æ›²çº¿ã€‚æˆ‘ä¼šè§£é‡Šå¸‚åœºåœ¨åšä»€ä¹ˆã€‚";
    if(mode==="eq"){
      emoji="ğŸ¤ğŸ˜";
      text="You are on equilibrium! At this price, quantity demanded equals quantity supplied. / ä½ è¾¾åˆ°äº†å‡è¡¡ç‚¹ï¼åœ¨è¿™ä¸ªä»·æ ¼ä¸‹ï¼Œéœ€æ±‚é‡ç­‰äºä¾›ç»™é‡ã€‚";
    } else if(mode==="shortage"){
      emoji="ğŸ¥ºğŸ“‰";
      text="Shortage! At this price, buyers want more than sellers provide. Prices will tend to rise. / çŸ­ç¼ºï¼åœ¨è¿™ä¸ªä»·æ ¼ä¸‹ï¼Œä¹°å®¶æƒ³è¦çš„æ¯”å–å®¶æä¾›çš„å¤šã€‚ä»·æ ¼ä¼šè¶‹äºä¸Šæ¶¨ã€‚";
    } else if(mode==="surplus"){
      emoji="ğŸ˜µâ€ğŸ’«ğŸ“ˆ";
      text="Surplus! At this price, sellers offer more than buyers want. Prices will tend to fall. / è¿‡å‰©ï¼åœ¨è¿™ä¸ªä»·æ ¼ä¸‹ï¼Œå–å®¶æä¾›çš„æ¯”ä¹°å®¶æƒ³è¦çš„å¤šã€‚ä»·æ ¼ä¼šè¶‹äºä¸‹é™ã€‚";
    }
    emojiBox.innerHTML=
      `<div class="emoji-face">${emoji}</div>`+
      `<div class="emoji-text">${text}</div>`;
    emojiBox.classList.remove("pop");
    void emojiBox.offsetWidth;
    emojiBox.classList.add("pop");
  }

  function updateValues(){
    currAD = Number(aD.value);
    currBD = Number(bD.value)/40;
    currAS = Number(aS.value);
    currBS = Number(bS.value)/40;
    const Pline = Number(priceLine.value);

    aDVal.textContent = currAD.toFixed(0);
    bDVal.textContent = currBD.toFixed(2);
    aSVal.textContent = currAS.toFixed(0);
    bSVal.textContent = currBS.toFixed(2);
    pVal.textContent  = Pline.toFixed(0);

    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawAxes();

    const Pd = q => currAD - currBD * q;
    const Ps = q => currAS + currBS * q;

    drawCurve("#ff5fa2", Pd);
    drawCurve("#4ade80", Ps);

    labelCurve("D","#ff5fa2", 65);
    labelCurve("S","#4ade80", 35);

    let eqVisible=false;
    let Qe=null, Pe=null;
    let eqDesc="";

    const denom = currBD + currBS;
    if(denom>0.0001){
      Qe = (currAD - currAS) / denom;
      Pe = Pd(Qe);
      if(Qe>=0 && Qe<=maxQ && Pe>=0 && Pe<=maxP){
        eqVisible = true;
        const x = qToX(Qe), y = pToY(Pe);

        ctx.setLineDash([6,6]);
        ctx.strokeStyle="#facc15";
        ctx.lineWidth=2;
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x, canvas.height - PAD_BOTTOM);
        ctx.moveTo(PAD_LEFT, y);
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.setLineDash([]);

        // Draw equilibrium point with LARGE pulsing glow
        // Add outer glow rings
        ctx.fillStyle="rgba(250,204,21,0.2)";
        ctx.beginPath();
        ctx.arc(x,y,22,0,Math.PI*2);
        ctx.fill();
        
        ctx.fillStyle="rgba(250,204,21,0.4)";
        ctx.beginPath();
        ctx.arc(x,y,16,0,Math.PI*2);
        ctx.fill();
        
        // Draw main equilibrium dot - MUCH LARGER
        drawDot(x,y,"#facc15",14);
        
        // Draw thick outline
        ctx.strokeStyle="#facc15";
        ctx.lineWidth=4;
        ctx.beginPath();
        ctx.arc(x,y,14,0,Math.PI*2);
        ctx.stroke();
        
        // Draw "E" label LARGER
        ctx.fillStyle="#facc15";
        ctx.font="bold 28px system-ui";
        ctx.strokeStyle="rgba(15,23,42,0.95)";
        ctx.lineWidth=4;
        ctx.strokeText("E",x+20,y-10);
        ctx.fillText("E",x+20,y-10);

        ctx.fillStyle="#facc15";
        ctx.font="bold 20px system-ui";
        ctx.strokeStyle="rgba(15,23,42,0.95)";
        ctx.lineWidth=4;
        ctx.strokeText(`Qáµ‰ = ${Qe.toFixed(1)}`, x-60, canvas.height-PAD_BOTTOM+32);
        ctx.fillText(`Qáµ‰ = ${Qe.toFixed(1)}`, x-60, canvas.height-PAD_BOTTOM+32);
        
        ctx.strokeText(`Páµ‰ = ${Pe.toFixed(1)}`, PAD_LEFT-75, y+8);
        ctx.fillText(`Páµ‰ = ${Pe.toFixed(1)}`, PAD_LEFT-75, y+8);

        eqDesc = `Equilibrium: Qáµ‰ = ${Qe.toFixed(1)}, Páµ‰ = ${Pe.toFixed(1)} / å‡è¡¡ç‚¹: Qáµ‰ = ${Qe.toFixed(1)}, Páµ‰ = ${Pe.toFixed(1)}`;
      } else {
        eqDesc = "Equilibrium is outside the visible grid. / å‡è¡¡ç‚¹åœ¨å¯è§èŒƒå›´å¤–ã€‚";
      }
    } else {
      eqDesc = "The curves are almost flat. Equilibrium is not clear. / æ›²çº¿å‡ ä¹æ˜¯å¹³çš„ã€‚å‡è¡¡ç‚¹ä¸æ¸…æ¥šã€‚";
    }

    const yPL = pToY(Pline);
    ctx.strokeStyle="#38bdf8";
    ctx.setLineDash([8,4]);
    ctx.lineWidth=3;
    ctx.beginPath();
    ctx.moveTo(PAD_LEFT,yPL);
    ctx.lineTo(canvas.width-PAD_RIGHT,yPL);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle="#38bdf8";
    ctx.font="bold 18px system-ui";
    ctx.strokeStyle="rgba(15,23,42,0.95)";
    ctx.lineWidth=3;
    ctx.strokeText(`P* = ${Pline.toFixed(1)}`, canvas.width-PAD_RIGHT-110, yPL-10);
    ctx.fillText(`P* = ${Pline.toFixed(1)}`, canvas.width-PAD_RIGHT-110, yPL-10);

    let Qd=null, Qs=null;
    if(currBD>0.0001) Qd = (currAD - Pline)/currBD;
    if(currBS>0.0001) Qs = (Pline - currAS)/currBS;

    let mode="none";
    let infoDesc="";

    if(Qd===null || Qs===null || isNaN(Qd) || isNaN(Qs) ||
       Qd<0 || Qd>maxQ || Qs<0 || Qs>maxQ){
      statsBox.innerHTML =
        `<div class="stats-line"><strong>Market:</strong> ${currentMarketLabel}</div>`+
        `<div class="stats-line"><strong>Equilibrium:</strong> ${eqDesc}</div>`+
        `<div class="stats-line"><strong>Current price:</strong> P* = ${Pline.toFixed(1)}.</div>`+
        `<div class="stats-line">At this price, one of the curves does not meet the price line inside the grid. Move P* or shift the curves.</div>`;
      setEmoji("none");
      return;
    }

    const xQd = qToX(Qd);
    const xQs = qToX(Qs);

    drawDotWithLabel(xQd,yPL,"#60a5fa","Qáµˆ",Qd.toFixed(1),9);
    drawDotWithLabel(xQs,yPL,"#22c55e","QË¢",Qs.toFixed(1),9);

    ctx.setLineDash([4,4]);
    ctx.strokeStyle="#60a5fa";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(xQd, yPL);
    ctx.lineTo(xQd, canvas.height - PAD_BOTTOM);
    ctx.stroke();

    ctx.strokeStyle="#22c55e";
    ctx.beginPath();
    ctx.moveTo(xQs, yPL);
    ctx.lineTo(xQs, canvas.height - PAD_BOTTOM);
    ctx.stroke();
    ctx.setLineDash([]);

    if(Qd > Qs){
      const startX = xQs;
      const width = xQd - xQs;
      const midX = startX + width/2;
      
      // Draw TRIANGULAR shortage area between Qs, Qd and equilibrium point
      if(eqVisible){
        const xEq = qToX(Qe);
        const yEq = pToY(Pe);
        
        // Draw triangle fill
        ctx.fillStyle="rgba(249,115,115,0.5)";
        ctx.beginPath();
        ctx.moveTo(xQs, yPL);  // Start at Qs on price line
        ctx.lineTo(xQd, yPL);  // Go to Qd on price line
        ctx.lineTo(xEq, yEq);  // Go to equilibrium point
        ctx.closePath();
        ctx.fill();
        
        // Draw triangle border
        ctx.strokeStyle="#f87171";
        ctx.lineWidth=3;
        ctx.beginPath();
        ctx.moveTo(xQs, yPL);
        ctx.lineTo(xQd, yPL);
        ctx.lineTo(xEq, yEq);
        ctx.closePath();
        ctx.stroke();
      }
      
      // Add horizontal bar at price line level for label
      ctx.fillStyle="rgba(249,115,115,0.85)";
      ctx.fillRect(startX, yPL-25, width, 50);
      
      // Thick border around label bar
      ctx.strokeStyle="#f87171";
      ctx.lineWidth=4;
      ctx.strokeRect(startX, yPL-25, width, 50);
      
      // Label with LARGE text
      ctx.fillStyle="#fff";
      ctx.font="bold 22px system-ui";
      ctx.strokeStyle="rgba(15,23,42,0.95)";
      ctx.lineWidth=4;
      const gapLabel = `Shortage / çŸ­ç¼º`;
      const gapNum = `Gap: ${(Qd-Qs).toFixed(1)}`;
      const gapWidth = ctx.measureText(gapLabel).width;
      ctx.strokeText(gapLabel, midX-gapWidth/2, yPL-30);
      ctx.fillText(gapLabel, midX-gapWidth/2, yPL-30);
      
      const numWidth = ctx.measureText(gapNum).width;
      ctx.font="bold 20px system-ui";
      ctx.strokeText(gapNum, midX-numWidth/2, yPL+8);
      ctx.fillText(gapNum, midX-numWidth/2, yPL+8);

      const gap = (Qd-Qs).toFixed(1);
      infoDesc = `Shortage / çŸ­ç¼º: Qáµˆ = ${Qd.toFixed(1)}, QË¢ = ${Qs.toFixed(1)}. Gap / ç¼ºå£ = ${gap}`;
      mode="shortage";
    } else if(Qs > Qd){
      const startX = xQd;
      const width = xQs - xQd;
      const midX = startX + width/2;
      
      // Draw TRIANGULAR surplus area between Qd, Qs and equilibrium point
      if(eqVisible){
        const xEq = qToX(Qe);
        const yEq = pToY(Pe);
        
        // Draw triangle fill
        ctx.fillStyle="rgba(74,222,128,0.45)";
        ctx.beginPath();
        ctx.moveTo(xQd, yPL);  // Start at Qd on price line
        ctx.lineTo(xQs, yPL);  // Go to Qs on price line
        ctx.lineTo(xEq, yEq);  // Go to equilibrium point
        ctx.closePath();
        ctx.fill();
        
        // Draw triangle border
        ctx.strokeStyle="#4ade80";
        ctx.lineWidth=3;
        ctx.beginPath();
        ctx.moveTo(xQd, yPL);
        ctx.lineTo(xQs, yPL);
        ctx.lineTo(xEq, yEq);
        ctx.closePath();
        ctx.stroke();
      }
      
      // Add horizontal bar at price line level for label
      ctx.fillStyle="rgba(74,222,128,0.75)";
      ctx.fillRect(startX, yPL-25, width, 50);
      
      // Thick border around label bar
      ctx.strokeStyle="#4ade80";
      ctx.lineWidth=4;
      ctx.strokeRect(startX, yPL-25, width, 50);
      
      // Label with LARGE text
      ctx.fillStyle="#fff";
      ctx.font="bold 22px system-ui";
      ctx.strokeStyle="rgba(15,23,42,0.95)";
      ctx.lineWidth=4;
      const gapLabel = `Surplus / è¿‡å‰©`;
      const gapNum = `Gap: ${(Qs-Qd).toFixed(1)}`;
      const gapWidth = ctx.measureText(gapLabel).width;
      ctx.strokeText(gapLabel, midX-gapWidth/2, yPL-30);
      ctx.fillText(gapLabel, midX-gapWidth/2, yPL-30);
      
      const numWidth = ctx.measureText(gapNum).width;
      ctx.font="bold 20px system-ui";
      ctx.strokeText(gapNum, midX-numWidth/2, yPL+8);
      ctx.fillText(gapNum, midX-numWidth/2, yPL+8);

      const gap = (Qs-Qd).toFixed(1);
      infoDesc = `Surplus / è¿‡å‰©: Qáµˆ = ${Qd.toFixed(1)}, QË¢ = ${Qs.toFixed(1)}. Gap / è¿‡é‡ = ${gap}`;
      mode="surplus";
    } else {
      infoDesc = `At P* = ${Pline.toFixed(1)}, Qáµˆ = QË¢ = ${Qd.toFixed(1)}. No shortage or surplus. / åœ¨P* = ${Pline.toFixed(1)}æ—¶ï¼ŒQáµˆ = QË¢ = ${Qd.toFixed(1)}ã€‚æ²¡æœ‰çŸ­ç¼ºæˆ–è¿‡å‰©ã€‚`;
      mode="eq";
    }

    let hint = "";
    if(eqVisible){
      if(mode==="eq"){
        hint = `âœ… You are at equilibrium E! / ä½ åœ¨å‡è¡¡ç‚¹Eï¼`;
      } else {
        hint = `ğŸ’¡ Tip / æç¤º: Move P* towards Páµ‰ = ${Pe.toFixed(1)} to reach equilibrium. / ç§»åŠ¨P*å‘Páµ‰ = ${Pe.toFixed(1)}ä»¥è¾¾åˆ°å‡è¡¡ã€‚`;
      }
    }

    statsBox.innerHTML =
      `<div class="stats-line"><strong>Market / å¸‚åœº:</strong> ${currentMarketLabel}</div>`+
      `<div class="stats-line"><strong>Equilibrium / å‡è¡¡:</strong> ${eqDesc}</div>`+
      `<div class="stats-line"><strong>Current price / å½“å‰ä»·æ ¼:</strong> P* = ${Pline.toFixed(1)}</div>`+
      `<div class="stats-line"><strong>At this price / åœ¨æ­¤ä»·æ ¼:</strong> Qáµˆ = ${Qd.toFixed(1)}, QË¢ = ${Qs.toFixed(1)}</div>`+
      `<div class="stats-line"><strong>Market result / å¸‚åœºç»“æœ:</strong> ${infoDesc}</div>`+
      (hint ? `<div class="stats-line">${hint}</div>` : "");

    setEmoji(mode);
  }

  function clamp(v,min,max){return v<min?min:v>max?max:v;}

  function handlePointerDown(ev){
    const rect = canvas.getBoundingClientRect();
    const x = ev.clientX - rect.left;
    const y = ev.clientY - rect.top;
    const Pline = Number(priceLine.value);
    const yPL = pToY(Pline);

    const distToPrice = Math.abs(y - yPL);
    const priceThreshold = 30;

    const w = canvas.width - PAD_LEFT - PAD_RIGHT;
    const q = clamp((x - PAD_LEFT)/w * maxQ, 0, maxQ);
    const PdVal = currAD - currBD * q;
    const PsVal = currAS + currBS * q;
    const xCurve = qToX(q);
    const yD = pToY(PdVal);
    const yS = pToY(PsVal);
    const distD = Math.hypot(x-xCurve, y-yD);
    const distS = Math.hypot(x-xCurve, y-yS);
    const curveThreshold = 30;

    dragTarget = null;

    if(distToPrice < priceThreshold){
      dragTarget = "price";
      dragStart = { Pstart: Pline };
      canvas.setPointerCapture(ev.pointerId);
      canvas.style.cursor = 'grabbing';
      return;
    }

    if(distD < curveThreshold && distD <= distS){
      dragTarget = "demand";
      dragStart = { Pstart: PdVal, aDStart: currAD };
      canvas.setPointerCapture(ev.pointerId);
      canvas.style.cursor = 'grabbing';
    } else if(distS < curveThreshold){
      dragTarget = "supply";
      dragStart = { Pstart: PsVal, aSStart: currAS };
      canvas.setPointerCapture(ev.pointerId);
      canvas.style.cursor = 'grabbing';
    }
  }

  function handlePointerMove(ev){
    const rect = canvas.getBoundingClientRect();
    const x = ev.clientX - rect.left;
    const y = ev.clientY - rect.top;
    
    // Show coordinate display
    if(x >= PAD_LEFT && x <= canvas.width - PAD_RIGHT && 
       y >= PAD_TOP && y <= canvas.height - PAD_BOTTOM){
      const w = canvas.width - PAD_LEFT - PAD_RIGHT;
      const h = canvas.height - PAD_TOP - PAD_BOTTOM;
      const q = ((x - PAD_LEFT) / w * maxQ).toFixed(1);
      const p = ((1 - (y - PAD_TOP) / h) * maxP).toFixed(1);
      coordDisplay.textContent = `Q: ${q}, P: ${p}`;
      coordDisplay.style.display = 'block';
    } else {
      coordDisplay.style.display = 'none';
    }

    if(!dragTarget || !dragStart) return;
    const pNew = yToP(y);

    if(dragTarget === "price"){
      let newP = clamp(pNew, Number(priceLine.min), Number(priceLine.max));
      priceLine.value = newP;
    } else if(dragTarget === "demand"){
      const deltaP = pNew - dragStart.Pstart;
      let newAD = dragStart.aDStart + deltaP;
      newAD = clamp(newAD, Number(aD.min), Number(aD.max));
      aD.value = newAD;
      currentMarketLabel = "Custom market / è‡ªå®šä¹‰å¸‚åœº";
    } else if(dragTarget === "supply"){
      const deltaP = pNew - dragStart.Pstart;
      let newAS = dragStart.aSStart + deltaP;
      newAS = clamp(newAS, Number(aS.min), Number(aS.max));
      aS.value = newAS;
      currentMarketLabel = "Custom market / è‡ªå®šä¹‰å¸‚åœº";
    }
    updateValues();
  }

  function handlePointerUp(ev){
    if(dragTarget){
      dragTarget=null;
      dragStart=null;
      canvas.releasePointerCapture(ev.pointerId);
      canvas.style.cursor = 'default';
    }
  }

  function applyMarket(key){
    const m = markets[key];
    if(!m) return;
    currentMarketLabel = m.label;
    aD.value = m.aD;
    bD.value = m.bD;
    aS.value = m.aS;
    bS.value = m.bS;
    priceLine.value = m.price;
    marketDescEl.textContent = m.desc;
    updateValues();
  }

  [aD,bD,aS,bS,priceLine].forEach(el=>{
    el.addEventListener("input",updateValues);
  });

  canvas.addEventListener("pointerdown",handlePointerDown);
  canvas.addEventListener("pointermove",handlePointerMove);
  canvas.addEventListener("pointerup",handlePointerUp);
  canvas.addEventListener("pointerleave",handlePointerUp);

  marketSelect.addEventListener("change",e=>{
    applyMarket(e.target.value);
  });

  // Helper functions for scenario buttons
  window.showEquilibrium = function(){
    const denom = currBD + currBS;
    if(denom > 0.0001){
      const Qe = (currAD - currAS) / denom;
      const Pe = currAD - currBD * Qe;
      if(Pe >= Number(priceLine.min) && Pe <= Number(priceLine.max)){
        priceLine.value = Pe;  // Use precise value, don't round
        updateValues();
      }
    }
  };

  window.showShortage = function(){
    const denom = currBD + currBS;
    if(denom > 0.0001){
      const Qe = (currAD - currAS) / denom;
      const Pe = currAD - currBD * Qe;
      const shortagePrice = Math.max(Number(priceLine.min), Pe - 15);
      priceLine.value = shortagePrice.toFixed(1);
      updateValues();
    }
  };

  window.showSurplus = function(){
    const denom = currBD + currBS;
    if(denom > 0.0001){
      const Qe = (currAD - currAS) / denom;
      const Pe = currAD - currBD * Qe;
      const surplusPrice = Math.min(Number(priceLine.max), Pe + 15);
      priceLine.value = surplusPrice.toFixed(1);
      updateValues();
    }
  };

  window.resetToDefault = function(){
    applyMarket('bubbletea');
  };

  window.addEventListener("resize",resizeCanvas);
  resizeCanvas();
  applyMarket("bubbletea");
})();
</script>
</body>
</html>
